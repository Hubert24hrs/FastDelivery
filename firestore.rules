rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    function isDriver() {
      return isAuthenticated() && getUserRole() == 'driver';
    }

    // ==================== USERS COLLECTION ====================
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can create their own profile during signup
      allow create: if isOwner(userId);
      
      // Users can update their own profile, admins can update any
      allow update: if isOwner(userId) || isAdmin();
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // ==================== RIDES COLLECTION ====================
    match /rides/{rideId} {
      // Passengers can read their own rides
      // Drivers can read pending rides and rides assigned to them
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.driverId == request.auth.uid ||
        (isDriver() && resource.data.status == 'pending') ||
        isAdmin()
      );
      
      // Any authenticated user can create a ride request
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Owner can cancel, driver can update status
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.driverId == request.auth.uid ||
        (isDriver() && resource.data.status == 'pending') ||
        isAdmin()
      );
      
      // Only admins can delete rides
      allow delete: if isAdmin();
      
      // Chat messages subcollection
      match /messages/{messageId} {
        allow read, write: if isAuthenticated() && (
          get(/databases/$(database)/documents/rides/$(rideId)).data.userId == request.auth.uid ||
          get(/databases/$(database)/documents/rides/$(rideId)).data.driverId == request.auth.uid
        );
      }
    }

    // ==================== COURIERS COLLECTION ====================
    match /couriers/{courierId} {
      // Similar rules to rides
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.riderId == request.auth.uid ||
        (isDriver() && resource.data.status == 'pending') ||
        isAdmin()
      );
      
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.riderId == request.auth.uid ||
        (isDriver() && resource.data.status == 'pending') ||
        isAdmin()
      );
      
      allow delete: if isAdmin();
    }

    // ==================== TRANSACTIONS COLLECTION ====================
    match /transactions/{transactionId} {
      // Users can only read their own transactions
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Transactions are created by the system (server-side) or authenticated user for themselves
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // No updates or deletes allowed (immutable financial records)
      allow update, delete: if false;
    }

    // ==================== DRIVER APPLICATIONS COLLECTION ====================
    match /driver_applications/{applicationId} {
      // Applicants can read their own application
      allow read: if isOwner(applicationId) || isAdmin();
      
      // Anyone authenticated can apply (create their own application)
      allow create: if isAuthenticated() && applicationId == request.auth.uid;
      
      // Only admins can update application status
      allow update: if isAdmin();
      
      // Only admins can delete applications
      allow delete: if isAdmin();
    }

    // ==================== RATINGS COLLECTION ====================
    match /ratings/{ratingId} {
      // Anyone can read ratings
      allow read: if isAuthenticated();
      
      // Users can create ratings for their completed rides
      allow create: if isAuthenticated();
      
      // No updates allowed (ratings are final)
      allow update, delete: if isAdmin();
    }

    // ==================== PROMOS COLLECTION ====================
    match /promos/{promoId} {
      // Anyone authenticated can read promos
      allow read: if isAuthenticated();
      
      // Only admins can create, update, delete promos
      allow create, update, delete: if isAdmin();
    }

    // ==================== REFERRALS COLLECTION ====================
    match /referrals/{referralId} {
      // Users can read their own referrals
      allow read: if isAuthenticated() && (
        resource.data.referrerId == request.auth.uid ||
        resource.data.refereeId == request.auth.uid ||
        isAdmin()
      );
      
      // Authenticated users can create referrals
      allow create: if isAuthenticated();
      
      // Only admins can update/delete
      allow update, delete: if isAdmin();
    }

    // ==================== FAVORITE DRIVERS COLLECTION ====================
    match /favorite_drivers/{favoriteId} {
      // Users can manage their own favorites
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // ==================== SAVED DESTINATIONS COLLECTION ====================
    match /saved_destinations/{destId} {
      // Users can manage their own saved destinations
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
  }
}
